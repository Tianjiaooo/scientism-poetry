name: Deploy to GoDaddy VPS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    # Test Frontend Build
    - name: Test Frontend Build
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
      run: |
        cd frontend
        # Create production env file
        echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > .env.production
        npm ci
        npm run build
        cd ..

    # Test Backend
    - name: Test Backend
      run: |
        cd backend
        npm ci
        cd ..

    # Setup SSH
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/encoded_key
        base64 -d /tmp/encoded_key > ~/.ssh/id_rsa
        rm /tmp/encoded_key
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        chmod 600 ~/.ssh/known_hosts

    # Deploy to VPS
    - name: Deploy to VPS
      run: |
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} '
          # Create temporary directory
          TEMP_DIR=$(mktemp -d) &&
          echo "Created temporary directory: $TEMP_DIR" &&

          # Clone repository to temporary directory
          git clone https://github.com/codeinwind/scientism-poetry.git $TEMP_DIR &&
          cd $TEMP_DIR &&

          # Create frontend production env file
          echo "Creating frontend production env file..." &&
          echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > frontend/.env.production &&
          echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > frontend/.env &&

          # Build frontend
          echo "Building frontend..." &&
          cd frontend &&
          npm ci &&
          npm run build &&
          cd .. &&

          # Create backend env file
          echo "Creating backend env file..." &&
          cat > backend/.env << EOL
          NODE_ENV=production
          PORT=${{ secrets.BACKEND_PORT }}
          MONGODB_URI=${{ secrets.MONGODB_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          LOG_DIR=/var/log/scientism-poetry
          EOL

          # Build backend
          echo "Building backend..." &&
          cd backend &&
          npm ci --production &&
          cd .. &&

          # Stop existing PM2 processes
          pm2 stop scientism-poetry-backend || true &&
          pm2 delete scientism-poetry-backend || true &&

          # Update production directories
          sudo rm -rf /var/www/scientism-poetry/frontend/* &&
          sudo rm -rf /var/www/scientism-poetry/backend/* &&
          
          # Copy frontend files including .env
          sudo cp -r frontend/build/* /var/www/scientism-poetry/frontend/ &&
          sudo cp frontend/.env /var/www/scientism-poetry/frontend/ &&
          sudo cp frontend/.env.production /var/www/scientism-poetry/frontend/ &&
          
          # Copy backend files
          sudo cp -r backend/* /var/www/scientism-poetry/backend/ &&

          # Ensure log directory exists with proper permissions
          sudo mkdir -p /var/log/scientism-poetry &&
          sudo chown -R $USER:$USER /var/log/scientism-poetry &&
          sudo chmod 755 /var/log/scientism-poetry &&

          # Start backend with PM2
          cd /var/www/scientism-poetry/backend &&
          pm2 start server.js --name scientism-poetry-backend &&

          # Reload Nginx
          sudo systemctl reload nginx &&

          # Verify frontend env files
          echo "Verifying frontend env files:" &&
          ls -la /var/www/scientism-poetry/frontend/.env* &&

          # Cleanup
          cd / &&
          rm -rf $TEMP_DIR &&

          echo "Deployment completed successfully!"
        '

    # Verify deployment
    - name: Verify deployment
      run: |
        # Extract base URL from REACT_APP_API_URL for health check
        API_BASE_URL=$(echo "${{ secrets.REACT_APP_API_URL }}" | sed "s|/api$||")
        
        ssh -i ~/.ssh/id_rsa -p ${{ secrets.VPS_PORT }} ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} "
          echo \"Checking PM2 status:\" &&
          pm2 list &&
          echo \"Checking API health:\" &&
          curl -s ${API_BASE_URL}/api/health &&
          echo \"Checking logs directory:\" &&
          ls -la /var/log/scientism-poetry &&
          echo \"Checking frontend env files:\" &&
          ls -la /var/www/scientism-poetry/frontend/.env* &&
          echo \"Deployment verification complete\"
        "
